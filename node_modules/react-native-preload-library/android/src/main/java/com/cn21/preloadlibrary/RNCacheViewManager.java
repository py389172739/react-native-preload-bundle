package com.cn21.preloadlibrary;

import android.app.Activity;
import android.content.Intent;
import android.net.Uri;
import android.os.Build;
import android.os.Bundle;
import android.provider.Settings;
import android.support.v4.util.ArrayMap;
import android.view.ViewParent;
import android.widget.Toast;

import com.facebook.common.logging.FLog;
import com.facebook.react.ReactApplication;
import com.facebook.react.ReactNativeHost;
import com.facebook.react.ReactRootView;
import com.facebook.react.common.ReactConstants;

import java.util.Map;

/**
 * 缓存view管理
 * Created by lizhj on 2017/6/26.
 */

public class RNCacheViewManager {
    public static final Map<String, ReactRootView> CACHE = new ArrayMap<>();
    public static final int REQUEST_OVERLAY_PERMISSION_CODE = 1111;
    public static final String REDBOX_PERMISSION_MESSAGE =
            "Overlay permissions needs to be granted in order for react native apps to run in dev mode";


    public static ReactRootView getRootView(String moduleName) {
        return CACHE.get(moduleName);
    }

    public static ReactNativeHost getReactNativeHost(Activity activity) {
        return ((ReactApplication) activity.getApplication()).getReactNativeHost();
    }

    public static void init(Activity act, Bundle launchOptions, String... moduleNames) {
        boolean needsOverlayPermission = false;
        CACHE.clear();
        if (BuildConfig.DEBUG && Build.VERSION.SDK_INT >= Build.VERSION_CODES.M && !Settings.canDrawOverlays(act)) {
            needsOverlayPermission = true;
            Intent serviceIntent = new Intent(Settings.ACTION_MANAGE_OVERLAY_PERMISSION, Uri.parse("package:" + act.getPackageName()));
            FLog.w(ReactConstants.TAG, REDBOX_PERMISSION_MESSAGE);
            Toast.makeText(act, REDBOX_PERMISSION_MESSAGE, Toast.LENGTH_LONG).show();
            act.startActivityForResult(serviceIntent, REQUEST_OVERLAY_PERMISSION_CODE);
        }

        for (String moduleName : moduleNames) {
            ReactRootView rootView = new ReactRootView(act);
            if (!needsOverlayPermission) {
                rootView.startReactApplication(
                        getReactNativeHost(act).getReactInstanceManager(),
                        moduleName,
                        launchOptions);
            }
            CACHE.put(moduleName, rootView);
        }

    }


    public static void onDestroy(String moduleName) {
        try {
            ViewParent parent = getRootView(moduleName).getParent();
            if (parent != null)
                ((android.view.ViewGroup) parent).removeView(getRootView(moduleName));
        } catch (Throwable e) {
            e.printStackTrace();
        }
    }

}
